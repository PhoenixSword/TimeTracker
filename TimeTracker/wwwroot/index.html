<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TimeTrackerToken</title>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.1/css/all.css">
    <!-- Bootstrap core CSS -->
    <link href="./lib/mdbootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Material Design Bootstrap -->
    <link href="./lib/mdbootstrap/css/mdb.min.css" rel="stylesheet">
    <!-- Your custom styles (optional) -->
    <link href="./lib/mdbootstrap/css/style.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/site.min.css" />

    <link href="./css/calendar.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark primary-color mb-5">

            <!-- Navbar brand -->
            <a class="navbar-brand" href="#">TimeTrackerToken</a>

            <!-- Collapse button -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#basicExampleNav"
                    aria-controls="basicExampleNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Collapsible content -->
            <div class="collapse navbar-collapse" id="basicExampleNav">

                <!-- Links -->
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">Calendar</a>
                    </li>

                </ul>
                <div class="form-inline">
                    <div id="name" class=" md-form my-0 d-inline-flex">
                        
                    </div>
                </div>
            </div>
            <!-- Collapsible content -->

        </nav>

    </header>
    <div class="container">
        <main role="main" class="pb-3">
            <main class="calendar-contain">
                <section class="title-bar">
                    <button class="title-bar__burger">
                        <span class="burger__lines">Toggle Menu</span>
                    </button>
                    <span class="title-bar__year"></span>
                    <div class="title-bar__controls">
                        <div class="title-bar__minimize"></div>
                        <div class="title-bar__maximize"></div>
                        <div class="title-bar__close"></div>
                    </div>
                </section>

                <aside class="calendar__sidebar">
                    <div class="sidebar__nav">
                        <!-- Icons by Icons8 -->
                        <span class="sidebar__nav-item"><img class="icon icons8-Plus-Math" width="22px" height="22px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAWUlEQVRYR+2WMQoAIAgA9f+PrsWmEMQSEa7Z8rzEUmle2pxfABhvYFkPpQtJb7TEAGAAAxgoM3AO/v1YXoPPm4TtANHKy64AAAxgAANjDERB3bjXXzEA8w1s3k4WIU0YaEoAAAAASUVORK5CYII="></span>
                        <span class="sidebar__nav-item"><img class="icon icons8-Share" width="22px" height="22px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAB+klEQVRYR+2W0VEdMQxFDxUQKoBUkFABUAFQAaGDUEFCBQkVABUAFRAqgFRAUgFQQTJnxprx2/V67f3h5+nnzfNK8vXVteQN3tk23nl/1gCWMrAD/AD2UwlvgTPgtbekSwB8AJ4Bf3Nz84+9IJYAuAJOgAfgKGNgD7gGvvSwsATAH2Ab2MpOKxsvgN9kodl6AHha6279tRyAa5ZFE4R6UBez1gogaM8T/gKO08JNJsjw+ZmAVEG0AMg3Pwf8/wRsDjK/AZ+TBr6lbxfA1xqCOQDS7um0A8BTa1L+fSBC/0u/lsfJ0mQ55gCE4KyplPaYJ1czVWHWAHidLoG/mfB6AIQgvTGnqXSj+BoAaTusBTegCRbusnKthNUABP157Rv2XHGxVd/XylAD8C+lmtNJDVQ0KH2KeaaSDxuL104hhsrnmIhh5bWMxmWHHMWXABjwODFsdhtAdMWXANSGzaSYMkpCvE3DqgQgar902DiW7ZKl+JEWSgBKCUITttvhO2Coh1r8qKeUAASFpWHTMu+jhKX4UQmnRFgaNp7Ufu9Aqpk+MYxyP9mTyZVnW+0a2vu9RrZSBeWLJ9qr31wTqKaf3+18ce0iRtr1s7WP3ow9TcauJr0CqpkbullMzqpzD4BIZHLBeOpPafF3OqWbCrLZlgBoTt7iuAawZuA/xAh3Ifk/Dm0AAAAASUVORK5CYII="></span>
                        <span class="sidebar__nav-item"><img class="icon icons8-Up" width="22px" height="22px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAxklEQVRYR+3VwQ2DMAyF4Z8NOkI36AodpZ2sjMAoHaWdoJWlIEXI4RHnwMWROAH2ZxuSiZPXdHJ+EjDagUcZ4Rwd5QjAkr9K4icQQkQBdfK1+BAiAvCShxG9gG3b6xGExtED8Gb+K6VbnNA3cRTQCl4DzNKNOALYC7oFdCMUQFXkAboQCvAGbkDrF2sBasQXuAIfb7NSgAtwB5bGTrcHWBFWhF3uUgC1wyqAen/4NExAdiA7kB3IDmQH5GGjHhg9DVV8eT8Bf2HqNiEP+isaAAAAAElFTkSuQmCC"></span>
                        <span class="sidebar__nav-item"><img class="icon icons8-Down" width="22px" height="22px" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAA4UlEQVRYR+2WgQnCMBBFXzdwBSdwBUfRyXQER3EUN1AOEgnxLrkkhYCkUFpI7/+Xf1fajcnHNtmfBTCawDu0sFunuzAYL4CVwEpgJbAS+P8EDsAZeBj/DbUELsAznKpE7WMkxSfgCtwVhRKAmN+AF3AM1x+JGkAUkUINwgKo1X1BagDyYElMA3Cbi7gHoASRAzSZtwBYEClAs3krgAYhQxbnI73XBrbrLdCK0p3m69bbYv79e2cgF9Agms17WpCCdPU830lvAlFHIORw93xvALO33oXRBLw+uw/hsHEUmJ7ABzErNiGyzfJcAAAAAElFTkSuQmCC"></span>
                    </div>
                    <h2 class="sidebar__heading"></h2>
                    <ul class="sidebar__list">
                        <li class="sidebar__list-item sidebar__list-item--complete"><span class="list-item__time">8.30</span> Team Meeting</li>
                        <li class="sidebar__list-item sidebar__list-item--complete"><span class="list-item__time">10.00</span> Lunch with Sasha</li>
                        <li class="sidebar__list-item"><span class="list-item__time">2.30</span> Design Review</li>
                        <li class="sidebar__list-item"><span class="list-item__time">4.00</span> Get Groceries</li>
                    </ul>
                </aside>

                <section class="calendar__days">
                    <section class="calendar__top-bar">
                        <span class="top-bar__days">Mon</span>
                        <span class="top-bar__days">Tue</span>
                        <span class="top-bar__days">Wed</span>
                        <span class="top-bar__days">Thu</span>
                        <span class="top-bar__days">Fri</span>
                        <span class="top-bar__days">Sat</span>
                        <span class="top-bar__days">Sun</span>
                    </section>
                </section>
            </main>
        </main>

        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">

            <!-- Add .modal-dialog-centered to .modal-dialog to vertically center the modal -->
            <div class="modal-dialog modal-dialog-centered" role="document">


                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLongTitle">Time Tracker</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true" class="font-weight-bold">&times;</span>
                        </button>
                    </div>
                    <form class="modal-form" onsubmit="return false;">
                        <div class="modal-body">
                            <span class="text-danger"></span>
                            <div class="md-form">
                                <input type="date" id="date" name="date" class="form-control" readonly >
                                <label for="date" class="input-active">Date</label>
                            </div>
                            <div class="md-form">
                                <input type="number" id="hours" name="hours" class="form-control" min="0" max="24">
                                <label for="hours" class="input-active">Hours</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <button data-toggle="modal" data-target="#exampleModalCenter" hidden="hidden" id="modal"></button>
    </div>


    <!-- SCRIPTS -->
    <!-- JQuery -->
    <script type="text/javascript" src="./lib/mdbootstrap/js/jquery-3.3.1.min.js"></script>
    <!-- Bootstrap tooltips -->
    <script type="text/javascript" src="./lib/mdbootstrap/js/popper.min.js"></script>
    <!-- Bootstrap core JavaScript -->
    <script type="text/javascript" src="./lib/mdbootstrap/js/bootstrap.min.js"></script>
    <!-- MDB core JavaScript -->
    <script type="text/javascript" src="./lib/mdbootstrap/js/mdb.min.js"></script>
    <script src="./js/site.js"></script>

    <script src="https://www.gstatic.com/firebasejs/4.1.3/firebase.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
<script>

    if (!firebase.apps.length) {
        firebase.initializeApp(config);
    }
    function checkColor(hours) {
        if ((hours > 0) && (hours <= 4)) {
            return "green";
        }
        else if (hours >= 8) {
            return "deep-orange";
        }
        else if ((hours > 4) && (hours < 8))
            return "stylish-color";
        return "";
    }

    function logOut(){
        firebase.auth().signOut().then(function() {
         singin = `<span class="nav-item">
                            <a class="nav-link text-white" href="./login.html">Login</a>
                        </span>
                        <span class="nav-item">
                            <a class="nav-link text-white" href="./register.html">Register</a>
                        </span>`;
          document.getElementById('name').innerHTML = singin;
        
          window.location.replace("/login.html");
        }, function(error) {
          // An error happened.
        });
    }

    var token = "";
    var element;
    var calendar = "";
    var singin = "";
    var date = new Date();
    var toggleModal = $('#modal');
    var inputDate = $('.modal-body').children().children().eq(0);
    var inputHours = $('.modal-body').children().children().eq(2);
    var modalForm = $('.modal-form');
    var spanError = $('.modal-body > span');

    $('body').delegate('.calendar__day.active', 'click', function () {
        spanError.html("");
        element = $(this);
        toggleModal.click();
        inputDate.val(date.getFullYear() + "-" + ("0" + (date.getMonth() + 1)).slice(-2) + "-" + ("0" + (element.children().eq(0).html())).slice(-2));
        inputHours.val(element.children().eq(1).children().eq(0).html());
    });
    $('body').delegate('.modal-form button', 'click', function () {
        if (modalForm[0].checkValidity()) {
            var form = modalForm.serializeArray();
            $.ajax({
                url: '/api',
                type: 'POST',
                contentType: "application/json; charset=utf-8",
                data : JSON.stringify({ "date": form[0].value, "hours": form[1].value }),
                beforeSend: function (xhr) {
                    xhr.setRequestHeader("Authorization", "Bearer " + token);
                },
                success: function (data) {
                    if (data === "") {
                        element.children().eq(1).children().eq(0).html(form[1].value);
                        spanError.html("");
                        toggleModal.click();
                        console.log(element.removeClass("green deep-orange stylish-color grey").addClass(checkColor(form[1].value)));
                    } else {
                        spanError.html(data);
                    }
                }
            });
        }
    })

    jQuery(document).ready(function ($) {
        
        
        firebase.auth().onAuthStateChanged(function(user) {
            if (user) {
              token = user.ie;
              singin = `<button class="btn my-0 py-0 mx-2 text-white">${user.email}</button>
                        <form method="post" asp-controller="Account" asp-action="LogOff">
                        <button class="btn my-0 py-0 mx-2 text-white" style="height: 26px;" onclick=logOut()>Logout</button></form>`;
              document.getElementById('name').innerHTML = singin;
              $.ajax({
                  url: '/api',
                  beforeSend: function (xhr) {
                      xhr.setRequestHeader("Authorization", "Bearer " + user.ie);
                  },
                  success: function (data) {
                      $.each(data, function (index, value) {
                          var span = $(`span[id=${index}]`);
                          span.html(value);
                          span.parent().parent().addClass(checkColor(value));
                      }); 
                  }
              });
            } else {
             
                window.location.replace("/login.html");
            singin = `<span class="nav-item">
                            <a class="nav-link text-white" href="./login.html">Login</a>
                        </span>
                        <span class="nav-item">
                            <a class="nav-link text-white" href="./register.html">Register</a>
                        </span>`;
            document.getElementById('name').innerHTML = singin;
          }
        });
        singin = "";
        var date = new Date();
        var today = date.getDate();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const weekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]

        var month = monthNames[date.getMonth()];
        var year = date.getFullYear();
        var days = new Date(year, date.getMonth() + 1, 0).getDate();
        var dayOfWeekNumber = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        var prevMonth = new Date(year, date.getMonth(), 0).getDate();
        var dayOfWeekName = weekdays[dayOfWeekNumber ];

        calendar = '<section class="calendar__week">';

        for (var k = prevMonth - dayOfWeekNumber + 2; k <= prevMonth; k++) {
            calendar += `<div class="calendar__day inactive"><span class="calendar__date">${k}</span></div>`;
        }
        for (var k = 1; k <= 7 - dayOfWeekNumber + 1; k++) {
            if (k == today) {
                calendar +=
                    `<div class="calendar__day active today ${checkColor(hours)}">
                        <span class="calendar__date">${k}</span>
                            <span class="calendar__task calendar__task--today">
                                <span id="${k}">0</span>  <span>hours</span>
                            </span>
                        </div>`;
            }
            else {
                calendar +=
                    `<div class="calendar__day active ${checkColor(hours)}">
                        <span class="calendar__date">${k}</span>
                        <span class="calendar__task"><span id="${k}">0</span>
                            <span>hours</span></span>
                    </div>`;
            }
        }

        calendar += `</section><section class="calendar__week">`;
        for (var i = 0, j = 7 - dayOfWeekNumber + 1; i < 35; i++ , j++) {
            var tempDate = new Date();
            var sectionDate = new Date(tempDate.setDate(today - 1 + i)).getDate();
            if (i % 7 == 0 && i > 0) {
                calendar += `</section><section class="calendar__week">`;
            }
            if (j >= days) {
                calendar += `
                    <div class="calendar__day inactive">
                        <span class="calendar__date">${sectionDate}</span>
                    </div>`;
            }
            else {
                if (sectionDate == today) {
                    calendar += `
                        <div class="calendar__day active today ${checkColor(hours)}">
                            <span class="calendar__date">${sectionDate}</span>
                            <span class="calendar__task calendar__task--today"><span id="${sectionDate}">0</span> <span>hours</span></span>
                        </div>`;
                }
                else {
                    calendar += `
                        <div class="calendar__day active ${checkColor(hours)}" >
                            <span class="calendar__date">${sectionDate}</span>
                            <span class="calendar__task"><span id="${sectionDate}">0</span> <span>hours</span></span>
                        </div>`;
                }
            }
        }
        calendar += '</section>';
        $('.calendar__days').append(calendar);
        $('.sidebar__heading').html(`${dayOfWeekName}<br>${month} ${today}`);
        $('.title-bar__year').html(`Calendar > ${month} ${year}`);
    });

</script>

</body>
</html>